using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using System.Xml.Linq;
using Vida.Model;
using System.Collections.Generic;
using Vida.DAO;
using Vida.ServiceFacade.ServiceFacades.Seguranca;
using Vida.ServiceFacade.ServiceFacades;
using Vida.ServiceFacade.ServiceFacades.Farmacia.Misc;
using System.Drawing;
using Vida.ServiceFacade.ServiceFacades.Localidade;

namespace Vida.View.Farmacia
{
    public partial class WebForm1 : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            if (!IsPostBack)
            {
                CarregaUsuarios();
            }
        }

        /// <summary>
        /// Carrega os usuários de acordo com as permissões do administrador
        /// </summary>
        private void CarregaUsuarios()
        {
            Usuario u = (Vida.Model.Usuario)Session["Usuario"];
            IList<Perfil> lp = u.Perfis.Where(p => p.Nome.Equals("Administrador")).ToList();
            IList<Usuario> lup = new List<Usuario>();

            foreach (Perfil p in lp)
            {
                IList<Usuario> lu = Factory.GetInstance<IUsuario>().BuscarPorModulo<Vida.Model.Usuario>(p.Modulo.Codigo);

                foreach (Vida.Model.Usuario us in lu)
                {
                    if (!lup.Contains(us))
                        lup.Add(us);
                }
            }
            lup = lup.OrderBy(p => p.Nome).ToList();
            GridView_Usuarios.DataSource = lup.OrderBy(p => p.Nome).ToList();
            GridView_Usuarios.DataBind();
            Session["lup"] = lup;

            IList<Vida.Model.Distrito> distritos = Factory.GetInstance<IVidaServiceFacade>().ListarTodos<Distrito>();
            foreach (Vida.Model.Distrito distrito in distritos)
                ddlConsultaDistrito.Items.Add(new ListItem(distrito.Nome, distrito.Codigo.ToString()));

        }

        protected void OnPageIndexChanging_Paginacao(object sender, GridViewPageEventArgs e)
        {
            CarregaUsuarios();
            GridView_Usuarios.PageIndex = e.NewPageIndex;
            GridView_Usuarios.DataBind();
        }

        protected void GridView_Usuarios_SelectedIndexChanged(object sender, EventArgs e)
        {
            int index = GridView_Usuarios.SelectedIndex;
            IList<Usuario> lup = (IList<Usuario>)Session["lup"];
            Usuario usuario = lup[index];
            lblNome.Text = usuario.Nome;
            Session["user"] = usuario;
            GridView_Usuarios.SelectedRowStyle.BackColor = Color.LightGray;

            int? codigoDistrito = Factory.GetInstance<IUsuarioDistritoFarmacia>().BuscarDistritoPorUsuario<int>(usuario.Codigo);
            if (codigoDistrito != null && codigoDistrito != 0)
            {
                Vida.Model.Distrito distrito = Factory.GetInstance<IVidaServiceFacade>().BuscarPorCodigo<Distrito>(codigoDistrito);
                lblVinculo.Text = distrito.Nome;
            }
            else
                lblVinculo.Text = "Nenhum";
            
            IList<Distrito> distritos = Factory.GetInstance<IVidaServiceFacade>().ListarTodos<Distrito>();
            foreach (Distrito d in distritos)
                ddlDistrito.Items.Add(new ListItem(d.Nome, d.Codigo.ToString()));
        }

        protected void btnVincular_Click(object sender, EventArgs e)
        {
            if (!Page.IsValid)
                return;

            Vida.Model.Usuario usuario = (Vida.Model.Usuario)Session["user"];
            //Vida.Model.Distrito distrito = Factory.GetInstance<IUsuarioDistritoFarmacia>().BuscarDistritoPorUsuario<Vida.Model.Distrito>(usuario.Codigo);
            Vida.Model.UsuarioDistritoFarmacia udf = Factory.GetInstance<IUsuarioDistritoFarmacia>().BuscarPorUsuario<UsuarioDistritoFarmacia>(usuario.Codigo);
            //Remove o vínculo com outro distrito que não seja o selecionado
            if (udf != null && udf.CodigoDistrito != int.Parse(ddlDistrito.SelectedValue))
            {
                Factory.GetInstance<IUsuarioDistritoFarmacia>().Deletar(udf);
            }

            //Adiciona o vinculo ao distrito selecionado, se não já existir
            udf = new UsuarioDistritoFarmacia();
            udf.CodigoDistrito = int.Parse(ddlDistrito.SelectedValue);
            udf.CodigoUsuario = usuario.Codigo;
            Factory.GetInstance<IUsuarioDistritoFarmacia>().Salvar(udf);

            ClientScript.RegisterClientScriptBlock(typeof(String), "ok", "<script type='text/javascript'>alert('Dados Salvos com Sucesso');</script>");
        }

        protected void CustomValidator1_ServerValidate(object source, ServerValidateEventArgs args)
        {
            args.IsValid = true;
            if (GridView_Usuarios.SelectedRow == null)
                args.IsValid = false;
        }

        protected void btnPesquisar_Click(object sender, EventArgs e)
        {
            Vida.Model.Distrito distrito = Factory.GetInstance<IDistrito>().BuscarPorCodigo<Distrito>(int.Parse(ddlConsultaDistrito.SelectedValue));
            IList<int> codigousuarios = Factory.GetInstance<IUsuarioDistritoFarmacia>().BuscarUsuariosPorDistrito<int>(distrito.Codigo);
            IList<Usuario> usuarios = new List<Usuario>();
            foreach (int u in codigousuarios)
            {
                usuarios.Add(Factory.GetInstance<IVidaServiceFacade>().BuscarPorCodigo<Usuario>(u));
            }
            GridViewUsuariosDistrito.DataSource = usuarios;
            GridViewUsuariosDistrito.DataBind();
        }
    }
}
